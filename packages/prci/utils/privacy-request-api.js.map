{"version":3,"file":"privacy-request-api.js","sources":["../../src/utils/privacy-request-api.ts"],"sourcesContent":["/* eslint-disable camelcase */\nimport { HistoryResponse } from '../models/history-response.js';\nimport { DATA_CATEGORY } from '../models/priv-terms.js';\nimport { PrivacyRequest } from '../models/privacy-request.js';\nimport { PrivacyResponse } from '../models/privacy-response.js';\n/**\n * Determine the correct mock header for a PrivacyRequest\n * @param request PrivacyRequest to get mock header for\n * @returns String to be used in the \"prefer\" header\n */\nfunction getMockHeader(request: PrivacyRequest): string {\n  // If more than 1 demand, send the default multi demand response\n  if (request.demands.length > 1) {\n    return 'code=200, example=TRANSPARENCY Multi-Response';\n  }\n\n  // Select the mock response corresponding to this action\n  if (request.demands.length === 1) {\n    const { action } = request.demands[0];\n    return `code=200, example=${action} Response`;\n  }\n\n  // If no demands get bad request response\n  return 'code=400';\n}\n\nfunction preProcessRequest(request: PrivacyRequest): PrivacyRequest {\n  // If all privacy scopes provided, this is the same as no restriction\n  const allDataCategories = Object.values(DATA_CATEGORY).filter(\n    dc => dc !== DATA_CATEGORY.ALL && !dc.includes('.')\n  );\n  request.demands.forEach(d => {\n    if (d.restrictions && d.restrictions.privacy_scope) {\n      const demandDcs = d.restrictions.privacy_scope!.map(psr => psr.dc);\n      if (allDataCategories.every(dc => demandDcs.includes(dc))) {\n        const demand = d;\n        delete demand.restrictions!.privacy_scope;\n      }\n    }\n  });\n\n  return request;\n}\n\n/**\n * Send a PrivacyRequest to the privacy-request API\n * @param {PrivacyRequest} request Request body to send\n * @param {boolean} mock Flag indicating if the mock endpoint should be used\n * @returns\n */\nexport async function sendPrivacyRequest(\n  request: PrivacyRequest,\n  mock: boolean = true\n): Promise<{ request_id: string }> {\n  const preparedRequest = preProcessRequest(request);\n  const url = mock\n    ? 'https://stoplight.io/mocks/blindnet/product-management:open-api/74767654/privacy-request'\n    : 'https://devkit-pce-staging.azurewebsites.net/v0/privacy-request';\n  const headers: any = mock\n    ? {\n        'Content-Type': 'application/json',\n        Prefer: getMockHeader(request),\n      }\n    : {\n        'Content-Type': 'application/json',\n        'Access-Control-Allow-Origin': '*',\n      };\n  return fetch(url, {\n    method: 'POST',\n    headers,\n    body: JSON.stringify(preparedRequest),\n  }).then(response => {\n    if (!response.ok) {\n      throw new Error(response.statusText);\n    }\n    return response.json() as Promise<{ request_id: string }>;\n  });\n}\n\nexport async function getRequestHistory() {\n  return fetch(\n    'https://devkit-pce-staging.azurewebsites.net/v0/privacy-request/history',\n    {\n      method: 'GET',\n      headers: { accept: 'application/json' },\n    }\n  ).then(response => {\n    if (!response.ok) {\n      throw new Error(response.statusText);\n    }\n    return response.json() as Promise<HistoryResponse>;\n  });\n}\n\nexport async function getRequest(requestId: string) {\n  return fetch(\n    `https://devkit-pce-staging.azurewebsites.net/v0/privacy-request/${requestId}`,\n    {\n      method: 'GET',\n      headers: { accept: 'application/json' },\n    }\n  ).then(response => {\n    if (!response.ok) {\n      throw new Error(response.statusText);\n    }\n    return response.json() as Promise<PrivacyResponse>;\n  });\n}\n"],"names":[],"mappings":"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"}